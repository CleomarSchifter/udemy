---
title: "Model tuning: Otimizando os parâmetros do modelo"
author: "Weslley Moura"
output: html_document
---

> Adaptei este material do livro Machine Learning Mastery in R, de Jason Brownlee
> http://machinelearningmastery.com/
> Para os que buscam proficiência em Machine Learning, considero uma leitura obrigatória.
> Créditos para machinelearningmastery

## Carrega os pacotes
```{r, cache=FALSE, message=FALSE, warning=FALSE}
library(randomForest)
library(mlbench)
library(caret)
```

## Carrega os dados
```{r}
data(Sonar)
dataset <- Sonar
x <- dataset[,1:60]
y <- dataset[,61]
```

## Cria algumas variáveis gerais
```{r}
set.seed(123)
metric <- "Accuracy"
mtry <- sqrt(ncol(x))
```

## Cria um modelo com parâmetros padrão. Note que o valor o parâmetro mtry foi fixado com um valor constante.
```{r, cache=FALSE, message=FALSE, warning=FALSE}
trainControl <- trainControl(method="repeatedcv", number=10, repeats=3)
tunegrid <- expand.grid(.mtry=mtry)
rfDefault <- train(Class~., data=dataset, method="rf", metric=metric, tuneGrid=tunegrid,trControl=trainControl)
print(rfDefault)
```

## Otimização do modelo com Random Search
```{r, cache=FALSE, message=FALSE, warning=FALSE}
trainControl <- trainControl(method="repeatedcv", number=10, repeats=3, search="random")
rfRandom <- train(Class~., data=dataset, method="rf", metric=metric, tuneLength=15,trControl=trainControl)
print(rfRandom)
```

Gráfico dos parâmetros testados
```{r}
plot(rfRandom)
```

Melhor parâmetro escolhido
```{r}
print(rfRandom$bestTune)
```

## Otimização do modelo com Grid Search
```{r}
trainControl <- trainControl(method="repeatedcv", number=10, repeats=3, search="grid")
tunegrid <- expand.grid(.mtry=c(1:15))
rfGrid <- train(Class~., data=dataset, method="rf", metric=metric, tuneGrid=tunegrid,trControl=trainControl)
#tunegrid <- expand.grid(.cp=seq(0,0.1,by=0.01)) for method="rpart"
print(rfGrid)
```

Gráfico dos parâmetros testados
```{r}
plot(rfGrid)
```

Melhor parâmetro escolhido
```{r}
print(rfGrid$bestTune)
```

## Otimização do modelo com Manual Search
```{r}
trainControl <- trainControl(method="repeatedcv", number=10, repeats=3, search="grid")
tunegrid <- expand.grid(.mtry=c(sqrt(ncol(x))))
modellist <- list()

for (ntree in c(1000, 1500, 2000, 2500)) {
  fit <- train(Class~., data=dataset, method="rf", metric=metric, tuneGrid=tunegrid, trControl=trainControl, ntree=ntree)
  key <- toString(ntree)
  modellist[[key]] <- fit
}

# Comparando os resultados
results <- resamples(modellist)
summary(results)
```

Gráfico dos parâmetros testados
```{r}
dotplot(results)
```

## Algorithm Tune (tuneRF)
```{r}
bestmtry <- tuneRF(x, y, stepFactor=1.5, improve=1e-5, ntree=500)
print(bestmtry)
```

